メダロット・バトルシステム仕様書 (v1.0)
1. ゲーム概要
    目的: 3対3のチームで構成されたメダロット同士の戦闘をシミュレートする。
    システム: 各メダロットが持つゲージの速度に応じて行動順が決定される、ATB（アクティブタイムバトル）風のコマンドバトル。
    勝利条件: 敵チームのリーダー機を機能停止させる。
    敗北条件: 味方チームのリーダー機が機能停止させられる。

2. 主要な概念定義
このセクションでは、ゲームに登場する主要なオブジェクトとその構成要素を定義します。

2.1. メダロット (Medarot)
プレイヤーが操作する機体の基本単位。
    基本情報:
        ID, Name: メダロットを識別するためのIDと名前。
        Team: 所属するチーム (Team1 or Team2)。
        IsLeader: チームのリーダー機であるかどうかのフラグ。

    構成要素:
        Medal: 機体の「頭脳」となるメダル。1機につき1つ搭載。
        Parts: 4つの部位（頭、右腕、左腕、脚部）に装備されたパーツの集合。

    戦闘中の状態:
        State: メダロットが現在どのような状態にあるかを示す。（詳細は 2.7. 参照）
        Gauge: 行動ゲージ。時間経過で増加し、最大になると行動準備が整う。
        SelectedPartKey: 実行を指示された行動（使用パーツ）。
        TargetedMedarot: 行動の対象となる敵メダロット。
        IsEvasionDisabled: 回避行動ができない状態。
        IsDefenseDisabled: 防御行動ができない状態。

2.2. パーツ (Part)
メダロットの身体を構成し、HPや武装の役割を持つ。
    部位 (Type):
        HEAD (頭部): 破壊されるとメダロットは機能停止する。
        R_ARM (右腕), L_ARM (左腕): 主に攻撃を担う。
        LEG (脚部): 機体の移動や回避に関わる。

    基本パラメータ:
        Armor / MaxArmor: パーツの耐久力（HP）。0になるとパーツは破壊される (IsBroken)。
        Power: 攻撃の威力。ダメージ計算の基礎値。
        Charge: 「充填」性能。行動の準備時間。
        Cooldown: 「冷却」性能。行動後の硬直時間。

    行動定義:
        Category: 行動のカテゴリ（SHOOT: 射撃, FIGHT: 格闘）。
        Trait: 行動の特性（NORMAL, AIM, STRIKE, BERSERK）。

2.3. メダル (Medal)
メダロットのAIや性格を司るコアユニット。
    基本情報: ID, Name, Personality（性格）, Attribute（属性）。
    スキルレベル: SkillShoot (射撃), SkillFight (格闘), SkillScan (索敵), SkillSupport (補助)。スキルレベルは対応する行動の性能に影響を与える。

2.4. 行動の分類 (ActionCategory, ActionTrait)
    大分類 (ActionCategory): SHOOT (射撃), FIGHT (格闘), NONE (行動なし)。
    特性 (ActionTrait): NORMAL, AIM (ねらいうち), STRIKE (がむしゃら), BERSERK (ぼうそう)。

2.5. チーム (TeamID)
戦闘は2つのチーム (Team1, Team2) に分かれて行われる。

2.6. ゲーム進行状態 (GameState)
ゲーム全体の状況を示す。
    StatePlaying: 戦闘が自動進行中。
    StatePlayerActionSelect: プレイヤーのコマンド入力を待っている状態。
    GameStateMessage: メッセージを表示している状態。
    GameStateOver: 戦闘が終了した状態。

2.7. メダロットの行動状態 (MedarotState)
各メダロットの行動サイクル。
    ReadyToSelectAction: 行動ゲージが100%の状態で、行動を選択できる。
    ActionCharging: 行動選択後、ゲージが0から「充填」を開始する。
    ReadyToExecuteAction: 充填ゲージが100%になり、行動を即時実行できる。
    ActionCooldown: 行動実行後、ゲージが0から「冷却」を開始する。
    Broken: 頭部パーツが破壊され、機能停止した状態。一切の行動が不能になる。

3. ゲームデータ
CSVファイルからロードされる、ゲームの基本的なパラメータ。

3.1. メダルデータ (medals.csv)
    id, name_jp: 識別子と名称。
    skill_shoot: 射撃スキルの熟練度。命中判定に影響。
    skill_fight: 格闘スキルの熟練度。命中判定とダメージ計算に影響。
    未使用: personality_jp, medaforce_jp, attribute_jp, skill_scan, skill_support。

3.2. パーツデータ (parts.csv)
    id, part_name: 識別子と名称。
    part_type: 部位 (HEAD, R_ARM, L_ARM, LEG)。
    action_category, action_trait: 行動の分類。
    armor: 装甲値（HP）。
    power: 威力。ダメージ計算の基礎値。
    charge, cooldown: 行動速度。ゲージ増加量に影響（値が大きいほど遅い）。
    defense: 防御性能。被ダメージを軽減。
    accuracy: 命中性能。命中判定の基礎値。
    mobility: 機動性能（脚部専用）。回避しやすさに影響。
    propulsion: 推進性能（脚部専用）。ゲージ速度とBERSERK時の威力に影響。
    未使用: weapon_type。

4. 戦闘の流れ（シーケンス）
戦闘は GameState という大枠の状態と、各メダロットの MedarotState という個別の状態によって進行する。

4.1. 初期化 (NewGame)
    CSVからゲームデータを読み込む。
    データに基づき、両チームのメダロットインスタンスを生成する。
    各チームのリーダー機を内部的にキャッシュする。
    各メダロットは StateReadyToSelectAction、Gauge: 100.0 の状態で戦闘が開始される。

4.2. メインループ (Update)
ゲームは1フレームごとに以下の状態に応じた処理を実行する。
    A. 自動進行フェーズ (StatePlaying)
        全メダロットのゲージを増加させる。
        ゲージが100%になったメダロットの状態を遷移させる。
        ReadyToExecuteAction のメダロットがいれば、メッセージフロー (4.3) を開始する。
        ReadyToSelectAction のメダロットがいれば、行動選択キューに追加（プレイヤー）するか、AIに行動選択（敵）させる。
        プレイヤーの行動選択キューにメダロットがいれば、B. コマンド入力フェーズ に移行する。
        勝敗条件をチェックし、満たしていれば D. 戦闘終了フェーズ に移行する。

    B. コマンド入力フェーズ (StatePlayerActionSelect)
        操作対象メダロットに対し、システムが仮のターゲットを自動選択する。
        プレイヤーが行動ボタンをクリックすると、行動が確定し ActionCharging 状態へ移行。
        行動選択キューから対象が取り除かれ、キューが空なら A. 自動進行フェーズ に戻る。

    C. メッセージ表示フェーズ (GameStateMessage)
        行動宣言や結果などのメッセージを表示し、ゲーム時間を停止する。
        クリックされると、次の処理へ進むか A. 自動進行フェーズ に戻る。

    D. 戦闘終了フェーズ (GameStateOver)
        勝敗結果メッセージを表示する。
        リセットボタンクリックでゲームを再起動する。

4.3. アクション実行のメッセージフロー
    行動宣言メッセージ: 「A: B (SHOOT) -> C！」のように表示。
    クリック待ち
    アクション実行: medarot.ExecuteAction() で内部処理（命中、ダメージ等）を実行。
    結果メッセージ: 「CのDにXXダメージ！」のように表示。
    クリック待ち
    フェーズ復帰: StatePlaying に戻る。

5. 戦闘メカニクス詳細
5.1. 行動選択 (SelectAction)
    ReadyToSelectAction 状態のメダロットのみ実行可能。
    選択したパーツが未破壊で、Charge 値が1以上である必要がある。

5.2. ターゲット選定
    攻撃対象メダロット: AIまたはプレイヤーによって一体が選択される。
    攻撃対象パーツ: 命中時、相手の未破壊の全パーツからランダムで1つが選択される。

5.3. 命中判定 (calculateHit)
    基本命中値: ベース命中チャンス + 最終命中性能 - 相手の機動性能
    最終命中性能: パーツの命中(Accuracy) + スキルレベル + 特性ボーナス
        スキルレベル: 射撃なら SkillShoot、格闘なら SkillFight を加算。
        特性ボーナス/ペナルティ: AIM と STRIKE はプラス、BERSERK はマイナス補正。
    相手の機動性能: ターゲットの脚部パーツの Mobility 値。回避不能なら0。
    最終判定: 0～99 の乱数が 基本命中値 より小さい場合に命中。
    クリティカルヒット: 基本命中値 が100を超えている場合、基本命中値 - 100 (%) の確率で発生。

5.4. ダメージ計算 (calculateDamage)
    基本ダメージ: (基本威力 - 最終防御力)
    基本威力: パーツの威力(Power) + (メダルの格闘スキル * スキル影響係数)
        BERSERK特性の場合、自身の脚部 Propulsion 値が威力に加算される。

    最終防御力: 被弾パーツの防御(Defense) + 被弾メダロットの脚部パーツの防御(Defense)
        防御不能状態なら0。

    最終ダメージ:
        クリティカルヒット時、基本ダメージに クリティカル倍率 を乗算。
        最低でも 1 のダメージを保証。

5.5. 特性による行動制約 (applyActionConstraints)
特定の行動を選択すると、行動完了まで自身にデメリットが発生する。
    AIM: 自身が 回避不能 になる。
    STRIKE: 自身が 防御不能 になる。
    BERSERK: 自身が 回避不能 かつ 防御不能 になる。

5.6. パーツ破壊と機能停止
    パーツの Armor が0以下になると、そのパーツは破壊される (IsBroken = true)。
    頭部パーツが破壊されると、そのメダロットは StateBroken (機能停止) となる。

5.7. AIの行動ロジック (handleAIAction)
    行動選択: 使用可能な攻撃パーツの中からランダムで1つを選択。
    ターゲット選択: 相手チームの生存しているメダロットの中からランダムで1体を選択。

6. 要検討・確認事項
    6.1. ダメージ計算における射撃スキル
        現状: ダメージ計算式で参照されるスキルは格闘スキル (SkillFight) のみ。
        課題: 射撃行動の威力がメダルの射撃スキルに依存していない。
        提案: 攻撃の ActionCategory に応じて参照するスキルを切り替えるロジックの追加を検討する。

    6.2. ターゲット選択ロジックの高度化
        現状: AIのターゲット選択は完全ランダム。
        課題: 戦略性に欠ける。
        提案: リーダー優先、低HP優先など、より高度なAIルーチンの仕様を策定する。プレイヤーがターゲットを選択するUI/ロジックも定義が必要。

    6.3. 未使用パラメータの活用
        現状: medaforce_jp, attribute_jp, weapon_type などが未使用。
        課題: データは存在するが機能が未実装。
        提案: 今後のマイルストーンで、属性相性、メダフォース、武器種ごとの特性などの仕様を策定する。
